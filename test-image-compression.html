<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-section {
            border: 2px dashed #ddd;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .upload-section.dragover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .result-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .error {
            color: #dc3545;
            border-left-color: #dc3545;
        }
        .success {
            color: #28a745;
            border-left-color: #28a745;
        }
        .image-preview {
            max-width: 300px;
            max-height: 300px;
            margin: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .comparison {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .image-info {
            text-align: center;
            flex: 1;
            min-width: 250px;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è –¢–µ—Å—Ç —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h1>
        
        <div class="upload-section" id="uploadSection">
            <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <p>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: JPEG, PNG</p>
            <input type="file" id="fileInput" accept="image/jpeg,image/png" />
            <br>
            <button onclick="testCompression()">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∂–∞—Ç–∏–µ</button>
            <button onclick="testRegistration()">üë§ –¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</p>
        </div>

        <div class="results" id="results" style="display: none;">
            <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <div id="resultContent"></div>
        </div>

        <div class="comparison" id="comparison" style="display: none;">
            <div class="image-info">
                <h4>–ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h4>
                <img id="originalImage" class="image-preview" />
                <div id="originalInfo"></div>
            </div>
            <div class="image-info">
                <h4>–°–∂–∞—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h4>
                <img id="compressedImage" class="image-preview" />
                <div id="compressedInfo"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000';
        
        // Drag and drop functionality
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
            }
        });

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showResults(show) {
            document.getElementById('results').style.display = show ? 'block' : 'none';
        }

        function addResult(message, isError = false) {
            const resultContent = document.getElementById('resultContent');
            const div = document.createElement('div');
            div.className = `result-item ${isError ? 'error' : 'success'}`;
            div.innerHTML = message;
            resultContent.appendChild(div);
        }

        function clearResults() {
            document.getElementById('resultContent').innerHTML = '';
            document.getElementById('comparison').style.display = 'none';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showImageComparison(originalFile, compressedUrl) {
            const comparison = document.getElementById('comparison');
            const originalImage = document.getElementById('originalImage');
            const compressedImage = document.getElementById('compressedImage');
            const originalInfo = document.getElementById('originalInfo');
            const compressedInfo = document.getElementById('compressedInfo');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const reader = new FileReader();
            reader.onload = (e) => {
                originalImage.src = e.target.result;
                originalInfo.innerHTML = `
                    <strong>–†–∞–∑–º–µ—Ä:</strong> ${formatFileSize(originalFile.size)}<br>
                    <strong>–¢–∏–ø:</strong> ${originalFile.type}<br>
                    <strong>–ò–º—è:</strong> ${originalFile.name}
                `;
            };
            reader.readAsDataURL(originalFile);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∂–∞—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            compressedImage.src = `${API_BASE}${compressedUrl}`;
            compressedImage.onload = () => {
                // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä —Å–∂–∞—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ fetch
                fetch(`${API_BASE}${compressedUrl}`)
                    .then(response => {
                        const contentLength = response.headers.get('content-length');
                        if (contentLength) {
                            const compressedSize = parseInt(contentLength);
                            const savings = ((originalFile.size - compressedSize) / originalFile.size * 100).toFixed(1);
                            compressedInfo.innerHTML = `
                                <strong>–†–∞–∑–º–µ—Ä:</strong> ${formatFileSize(compressedSize)}<br>
                                <strong>–¢–∏–ø:</strong> JPEG<br>
                                <strong>–≠–∫–æ–Ω–æ–º–∏—è:</strong> ${savings}%
                            `;
                        } else {
                            compressedInfo.innerHTML = `
                                <strong>–¢–∏–ø:</strong> JPEG<br>
                                <strong>URL:</strong> ${compressedUrl}
                            `;
                        }
                    })
                    .catch(() => {
                        compressedInfo.innerHTML = `
                            <strong>–¢–∏–ø:</strong> JPEG<br>
                            <strong>URL:</strong> ${compressedUrl}
                        `;
                    });
            };

            comparison.style.display = 'flex';
        }

        async function testCompression() {
            const file = fileInput.files[0];
            if (!file) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }

            clearResults();
            showResults(true);
            showLoading(true);

            try {
                addResult(`üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞: ${file.name}`);
                addResult(`üìè –ò—Å—Ö–æ–¥–Ω—ã–π —Ä–∞–∑–º–µ—Ä: ${formatFileSize(file.size)}`);
                addResult(`üé® –¢–∏–ø —Ñ–∞–π–ª–∞: ${file.type}`);

                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                const formData = new FormData();
                formData.append('photo', file);
                formData.append('gender', 'male');
                formData.append('interests', 'female');
                formData.append('age-range', '18-25');

                // –°–æ–∑–¥–∞–µ–º —Ñ–µ–π–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ Telegram
                const tgInitData = 'user=%7B%22id%22%3A123456789%2C%22first_name%22%3A%22Test%22%2C%22last_name%22%3A%22User%22%2C%22username%22%3A%22testuser%22%2C%22language_code%22%3A%22ru%22%7D&hash=test';

                const response = await fetch(`${API_BASE}/api/registration`, {
                    method: 'POST',
                    headers: {
                        'X-Telegram-Init-Data': tgInitData
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                addResult(`‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ —Å–∂–∞—Ç–æ!`);
                addResult(`üìÅ –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É: ${result.photo}`);
                addResult(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω —Å ID: ${result.id}`);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                showImageComparison(file, result.photo);

            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, true);
                console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
            } finally {
                showLoading(false);
            }
        }

        async function testRegistration() {
            const file = fileInput.files[0];
            if (!file) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }

            clearResults();
            showResults(true);
            showLoading(true);

            try {
                addResult(`üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...`);
                
                const formData = new FormData();
                formData.append('photo', file);
                formData.append('gender', 'female');
                formData.append('interests', 'male');
                formData.append('age-range', '25-35');

                const tgInitData = `user=%7B%22id%22%3A${Date.now()}%2C%22first_name%22%3A%22Test%22%2C%22last_name%22%3A%22User%22%2C%22username%22%3A%22testuser${Date.now()}%22%2C%22language_code%22%3A%22ru%22%7D&hash=test`;

                const response = await fetch(`${API_BASE}/api/registration`, {
                    method: 'POST',
                    headers: {
                        'X-Telegram-Init-Data': tgInitData
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                
                addResult(`‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!`);
                addResult(`üë§ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${result.id}`);
                addResult(`üë§ –ò–º—è: ${result.firstName} ${result.lastName}`);
                addResult(`‚ößÔ∏è –ü–æ–ª: ${result.gender}`);
                addResult(`üíï –ò–Ω—Ç–µ—Ä–µ—Å—ã: ${result.interestsGender}`);
                addResult(`üéÇ –í–æ–∑—Ä–∞—Å—Ç: ${result.ageRange}`);
                addResult(`üñºÔ∏è –§–æ—Ç–æ: ${result.photo}`);
                addResult(`‚≠ê –û—á–∫–∏: ${result.restScores}`);

                showImageComparison(file, result.photo);

            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${error.message}`, true);
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
            } finally {
                showLoading(false);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    console.log('‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω');
                } else {
                    console.warn('‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π');
                }
            } catch (error) {
                console.error('‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
                alert('‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 4000.');
            }
        });
    </script>
</body>
</html>